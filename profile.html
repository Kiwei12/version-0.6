<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil | Anime Uz</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: linear-gradient(120deg, #181a20 60%, #23243a 100%);
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            color: #fff;
        }
        .profile-hero {
            background: url('images/profile-bg.jpg'), linear-gradient(120deg, #23243a 60%, #181a20 100%);
            background-size: cover;
            background-position: center;
            min-height: 260px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            position: relative;
            padding-bottom: 30px;
        }
        .profile-avatar {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            border: 4px solid #3bb6ff;
            object-fit: cover;
            margin-top: 10px;
            background: #fff;
            box-shadow: 0 4px 24px #0006;
        }
        .profile-name {
            font-size: 2.1rem;
            font-weight: 700;
            margin-top: 18px;
            color: #ffb84b;
            text-shadow: 0 2px 8px #000a;
            background: rgba(24,26,32,0.85);
            padding: 6px 28px;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0003;
        }
        .profile-email {
            color: #b2b6c8;
            font-size: 1.13rem;
            margin-bottom: 0;
            margin-top: 10px;
            background: rgba(24,26,32,0.85);
            padding: 4px 18px;
            border-radius: 8px;
            box-shadow: 0 2px 12px #0002;
        }
        .profile-main {
            max-width: 820px;
            margin: 30px auto 0 auto;
            background: #23243af2;
            border-radius: 24px;
            box-shadow: 0 8px 48px #0007;
            padding: 48px 48px 38px 48px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 38px;
        }
        .profile-section {
            margin-bottom: 0;
            background: #181a20;
            border-radius: 16px;
            box-shadow: 0 2px 12px #0002;
            padding: 24px 24px 18px 24px;
            margin-top: 0;
            margin-bottom: 0;
        }
        .profile-section-title {
            color: #3bb6ff;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 16px;
        }
        .profile-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
        }
        .profile-list li {
            background: #23243a;
            border-radius: 10px;
            padding: 10px 18px 10px 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.08rem;
            box-shadow: 0 1px 6px #0001;
        }
        .profile-list img {
            width: 40px;
            height: 54px;
            border-radius: 8px;
            object-fit: cover;
        }
        .profile-badge {
            display: inline-block;
            margin-top: 4px;
            font-size: 1.13rem;
            font-weight: 700;
            padding: 7px 22px;
            border-radius: 12px;
            background: #3bb6ff;
            color: #fff;
            box-shadow: 0 2px 8px #0002;
        }
        .profile-settings-row {
            display: flex;
            gap: 24px;
            margin-bottom: 14px;
        }
        .profile-settings-row label {
            color: #fff;
            font-size: 1.01rem;
        }
        .profile-settings-row select {
            padding: 3px 8px;
            border-radius: 6px;
            border: none;
            background: #181a20;
            color: #fff;
        }
        @media (max-width: 700px) {
            .profile-main {
                max-width: 99vw;
                padding: 10px 2vw 14px 2vw;
                gap: 18px;
            }
            .profile-hero {
                min-height: 90px;
                padding-bottom: 10px;
            }
            .profile-avatar {
                width: 54px;
                height: 54px;
                margin-top: 6px;
            }
            .profile-name {
                font-size: 1rem;
            }
            .profile-section-title {
                font-size: 1rem;
            }
            .profile-section {
                padding: 12px 7px 10px 7px;
                border-radius: 10px;
            }
            .profile-list li {
                font-size: 0.93rem;
                padding: 5px 7px 5px 5px;
                border-radius: 6px;
            }
            .profile-list img {
                width: 22px;
                height: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="profile-hero">
        <button id="editProfileBtn" style="position:absolute;top:18px;right:28px;background:#3bb6ff;color:#fff;border:none;border-radius:50%;width:38px;height:38px;font-size:1.3rem;cursor:pointer;box-shadow:0 2px 8px #0003;z-index:2;" title="Tahrirlash">✏️</button>
        <img src="images/default-avatar.png" alt="Avatar" class="profile-avatar" id="profilePageAvatar">
        <div class="profile-name" id="profilePageName">Foydalanuvchi</div>
        <div class="profile-email" id="profilePageEmail">email@example.com</div>
        <!-- Banner tahrirlash modal -->
        <div id="editProfileModal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
            <div style="background:#23243a;max-width:420px;width:96vw;border-radius:18px;padding:28px 18px 18px 18px;position:relative;box-shadow:0 8px 32px #0007;">
                <button id="closeEditProfileModal" style="position:absolute;top:12px;right:18px;background:#ff4b4b;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:1.3rem;cursor:pointer;">&times;</button>
                <div style="color:#3bb6ff;font-size:1.18rem;font-weight:600;margin-bottom:18px;">Profilni tahrirlash</div>
                <form id="editProfileForm">
                    <div style="margin-bottom:18px;">
                        <label style="color:#fff;font-weight:500;">Banner (fon rasmi):</label><br>
                        <input type="file" id="editBannerInput" accept="image/*" style="margin-top:7px;">
                        <div style="margin-top:7px;">
                            <img id="editBannerPreview" src="" alt="Banner preview" style="width:100%;max-height:90px;object-fit:cover;border-radius:8px;display:none;">
                        </div>
                    </div>
                    <div style="margin-bottom:18px;">
                        <label style="color:#fff;font-weight:500;">Avatar (logo):</label><br>
                        <input type="file" id="editAvatarInput" accept="image/*" style="margin-top:7px;">
                        <div style="margin-top:7px;">
                            <img id="editAvatarPreview" src="" alt="Avatar preview" style="width:70px;height:70px;object-fit:cover;border-radius:50%;border:2px solid #3bb6ff;display:none;">
                        </div>
                    </div>
                    <div style="margin-bottom:18px;">
                        <label style="color:#fff;font-weight:500;">Nik (ism):</label><br>
                        <input type="text" id="editNameInput" style="margin-top:7px;width:90%;padding:7px;border-radius:6px;border:1.5px solid #3bb6ff;font-size:1.08rem;background:#181a20;color:#fff;" maxlength="32" placeholder="Ismingiz">
                    </div>
                    <button type="submit" style="background:#3bb6ff;color:#fff;border:none;border-radius:8px;padding:8px 28px;font-size:1.08rem;font-weight:600;cursor:pointer;">Saqlash</button>
                </form>
            </div>
        </div>
    </div>
    <div class="profile-main">
                <div class="profile-section" id="profile-playlists-section">
                    <div class="profile-section-title" style="display:flex;align-items:center;justify-content:space-between;">
                        <span>Shaxsiy playlistlar</span>
                        <button id="addPlaylistBtn" style="background:#3bb6ff;color:#fff;border:none;border-radius:8px;padding:6px 18px;font-size:1rem;font-weight:600;cursor:pointer;">+ Yangi playlist</button>
                    </div>
                    <div id="playlistsList" style="display:flex;flex-wrap:wrap;gap:18px;"></div>
                    <div id="playlistsEmpty" style="color:#b2b6c8;font-size:0.98rem;display:none;">Playlistlar yo‘q</div>
                    <!-- Playlist yaratish/tahrirlash modal -->
                    <div id="playlistModal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
                        <div style="background:#23243a;max-width:420px;width:96vw;border-radius:18px;padding:28px 18px 18px 18px;position:relative;box-shadow:0 8px 32px #0007;">
                            <button id="closePlaylistModal" style="position:absolute;top:12px;right:18px;background:#ff4b4b;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:1.3rem;cursor:pointer;">&times;</button>
                            <div style="color:#3bb6ff;font-size:1.18rem;font-weight:600;margin-bottom:18px;">Playlist yaratish</div>
                            <form id="playlistForm">
                                <input type="hidden" id="playlistEditIndex">
                                <div style="margin-bottom:18px;">
                                    <label style="color:#fff;font-weight:500;">Playlist nomi:</label><br>
                                    <input type="text" id="playlistNameInput" style="margin-top:7px;width:90%;padding:7px;border-radius:6px;border:1.5px solid #3bb6ff;font-size:1.08rem;background:#181a20;color:#fff;" maxlength="32" placeholder="Mening playlistim" required>
                                </div>
                                <button type="submit" style="background:#3bb6ff;color:#fff;border:none;border-radius:8px;padding:8px 28px;font-size:1.08rem;font-weight:600;cursor:pointer;">Saqlash</button>
                            </form>
                        </div>
                    </div>
                    <!-- Playlist ichidagi animelar modal -->
                    <div id="playlistAnimeModal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
                        <div style="background:#23243a;max-width:700px;width:96vw;max-height:90vh;overflow-y:auto;border-radius:18px;padding:28px 18px 18px 18px;position:relative;box-shadow:0 8px 32px #0007;">
                            <button id="closePlaylistAnimeModal" style="position:absolute;top:12px;right:18px;background:#ff4b4b;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:1.3rem;cursor:pointer;">&times;</button>
                            <div id="playlistAnimeModalTitle" style="color:#3bb6ff;font-size:1.18rem;font-weight:600;margin-bottom:18px;"></div>
                            <div id="playlistAnimeList" style="display:flex;flex-wrap:wrap;gap:18px;justify-content:center;"></div>
                            <div id="playlistAnimeEmpty" style="color:#b2b6c8;font-size:1.05rem;display:none;">Bu playlistda anime yo‘q</div>
                            <div style="margin-top:18px;text-align:center;">
                                <button id="addAnimeToPlaylistBtn" style="background:#3bb6ff;color:#fff;border:none;border-radius:8px;padding:8px 22px;font-size:1.01rem;font-weight:600;cursor:pointer;">Anime qo‘shish</button>
                            </div>
                            <div id="addAnimeList" style="display:none;margin-top:18px;flex-wrap:wrap;gap:12px;justify-content:center;"></div>
                        </div>
                    </div>
                </div>
        <div class="profile-section">
            <div class="profile-section-title">Sevimli animelar</div>
            <ul class="profile-list" id="profilePageFavorites"></ul>
            <div id="profilePageFavoritesEmpty" style="color:#b2b6c8;font-size:0.98rem;display:none;">Sevimli animelar yo‘q</div>
        </div>
        <div class="profile-section">
            <div class="profile-section-title">Ko‘rilgan animelar statistikasi</div>
            <div id="profilePageStats"></div>
        </div>
        <div class="profile-section">
            <div class="profile-section-title">Daraja</div>
            <div id="profilePageBadge" class="profile-badge"></div>
        </div>
        <div class="profile-section">
            <div class="profile-section-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>So‘nggi ko‘rilgan animelar</span>
                <button id="openRecentlyModal" style="background:#3bb6ff;color:#fff;border:none;border-radius:8px;padding:6px 18px;font-size:1rem;font-weight:600;cursor:pointer;">Ko‘rish</button>
            </div>
            <div id="profilePageRecentlyShort" style="display:flex;gap:10px;align-items:center;margin-top:7px;"></div>
            <div id="profilePageRecentlyEmpty" style="color:#b2b6c8;font-size:0.98rem;display:none;">So‘nggi ko‘rilgan animelar yo‘q</div>

            <!-- Modal for recently viewed anime -->
            <div id="recentlyModal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
                <div style="background:#23243a;max-width:700px;width:96vw;max-height:90vh;overflow-y:auto;border-radius:18px;padding:28px 18px 18px 18px;position:relative;box-shadow:0 8px 32px #0007;">
                    <button id="closeRecentlyModal" style="position:absolute;top:12px;right:18px;background:#ff4b4b;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:1.3rem;cursor:pointer;">&times;</button>
                    <div style="color:#3bb6ff;font-size:1.18rem;font-weight:600;margin-bottom:18px;">So‘nggi ko‘rilgan animelar</div>
                    <div id="recentlyModalList" style="display:flex;flex-wrap:wrap;gap:18px;justify-content:center;"></div>
                </div>
            </div>
        </div>
        <div class="profile-section">
            <div class="profile-section-title">Sozlamalar</div>
            <div class="profile-settings-row">
                <label for="profilePageLang">Til:</label>
                <select id="profilePageLang">
                    <option value="uz">O'zbekcha</option>
                    <option value="ru">Русский</option>
                </select>
            </div>
            <div class="profile-settings-row">
                <label for="profilePageTheme">Tema:</label>
                <select id="profilePageTheme">
                    <option value="dark">Tungi</option>
                    <option value="light">Kunduzgi</option>
                </select>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
    <script>
    // Playlistlar funksionalligi
    document.addEventListener('DOMContentLoaded', function() {
        // Playlistlar localStorage
        function getPlaylists() {
            return JSON.parse(localStorage.getItem('userPlaylists') || '[]');
        }
        function savePlaylists(arr) {
            localStorage.setItem('userPlaylists', JSON.stringify(arr));
        }
        // Render playlistlar
        function renderPlaylists() {
            const list = document.getElementById('playlistsList');
            const empty = document.getElementById('playlistsEmpty');
            list.innerHTML = '';
            const playlists = getPlaylists();
            if (!playlists.length) {
                list.style.display = 'none';
                empty.style.display = '';
                return;
            }
            list.style.display = 'flex';
            empty.style.display = 'none';
            playlists.forEach((pl, idx) => {
                const card = document.createElement('div');
                card.style.background = '#181a20';
                card.style.borderRadius = '12px';
                card.style.boxShadow = '0 2px 12px #0002';
                card.style.padding = '18px 18px 14px 18px';
                card.style.display = 'flex';
                card.style.flexDirection = 'column';
                card.style.alignItems = 'flex-start';
                card.style.gap = '8px';
                card.style.width = '210px';
                card.style.position = 'relative';
                card.innerHTML = `<div style='color:#ffb84b;font-weight:700;font-size:1.13rem;'>${pl.name}</div>` +
                    `<div style='color:#b2b6c8;font-size:0.98rem;'>${pl.animeIds?.length || 0} ta anime</div>` +
                    `<div style='display:flex;gap:8px;margin-top:8px;'>
                        <button class='playlist-view-btn' data-idx='${idx}' style='background:#3bb6ff;color:#fff;border:none;border-radius:7px;padding:5px 14px;font-size:0.98rem;font-weight:600;cursor:pointer;'>Ko‘rish</button>
                        <button class='playlist-edit-btn' data-idx='${idx}' style='background:#ffb84b;color:#23243a;border:none;border-radius:7px;padding:5px 14px;font-size:0.98rem;font-weight:600;cursor:pointer;'>Tahrirlash</button>
                        <button class='playlist-delete-btn' data-idx='${idx}' style='background:#ff4b4b;color:#fff;border:none;border-radius:7px;padding:5px 14px;font-size:0.98rem;font-weight:600;cursor:pointer;'>O‘chirish</button>
                    </div>`;
                list.appendChild(card);
            });
            // Eventlar
            list.querySelectorAll('.playlist-view-btn').forEach(btn => {
                btn.onclick = function() { openPlaylistAnimeModal(parseInt(btn.dataset.idx)); };
            });
            list.querySelectorAll('.playlist-edit-btn').forEach(btn => {
                btn.onclick = function() { openPlaylistModal(parseInt(btn.dataset.idx)); };
            });
            list.querySelectorAll('.playlist-delete-btn').forEach(btn => {
                btn.onclick = function() {
                    if (confirm('Playlistni o‘chirishni tasdiqlaysizmi?')) {
                        const playlists = getPlaylists();
                        playlists.splice(parseInt(btn.dataset.idx), 1);
                        savePlaylists(playlists);
                        renderPlaylists();
                    }
                };
            });
        }
        // Playlist yaratish modal
        const addBtn = document.getElementById('addPlaylistBtn');
        const modal = document.getElementById('playlistModal');
        const closeModal = document.getElementById('closePlaylistModal');
        const form = document.getElementById('playlistForm');
        const nameInput = document.getElementById('playlistNameInput');
        const editIndexInput = document.getElementById('playlistEditIndex');
        function openPlaylistModal(idx) {
            if (typeof idx === 'number') {
                // Tahrirlash
                const playlists = getPlaylists();
                nameInput.value = playlists[idx].name;
                editIndexInput.value = idx;
            } else {
                // Yangi
                nameInput.value = '';
                editIndexInput.value = '';
            }
            modal.style.display = 'flex';
        }
        if (addBtn && modal) addBtn.onclick = () => openPlaylistModal();
        if (closeModal && modal) closeModal.onclick = () => { modal.style.display = 'none'; };
        if (form) {
            form.onsubmit = function(e) {
                e.preventDefault();
                const playlists = getPlaylists();
                const name = nameInput.value.trim();
                if (!name) return;
                const idx = editIndexInput.value;
                if (idx !== '') {
                    playlists[idx].name = name;
                } else {
                    playlists.push({ name, animeIds: [] });
                }
                savePlaylists(playlists);
                modal.style.display = 'none';
                renderPlaylists();
            };
        }
        // Playlist ichidagi animelar modal
        const animeModal = document.getElementById('playlistAnimeModal');
        const closeAnimeModal = document.getElementById('closePlaylistAnimeModal');
        const animeListDiv = document.getElementById('playlistAnimeList');
        const animeEmpty = document.getElementById('playlistAnimeEmpty');
        const animeTitle = document.getElementById('playlistAnimeModalTitle');
        const addAnimeBtn = document.getElementById('addAnimeToPlaylistBtn');
        const addAnimeList = document.getElementById('addAnimeList');
        let currentPlaylistIdx = null;
        function openPlaylistAnimeModal(idx) {
            currentPlaylistIdx = idx;
            const playlists = getPlaylists();
            const pl = playlists[idx];
            animeTitle.textContent = pl.name;
            animeListDiv.innerHTML = '';
            if (pl.animeIds && pl.animeIds.length && typeof animeData !== 'undefined') {
                pl.animeIds.forEach(id => {
                    const anime = animeData.find(a => a.id === id);
                    if (anime) {
                        const card = document.createElement('div');
                        card.style.background = '#181a20';
                        card.style.borderRadius = '10px';
                        card.style.width = '140px';
                        card.style.boxShadow = '0 2px 12px #0002';
                        card.style.padding = '10px 8px 12px 8px';
                        card.style.display = 'flex';
                        card.style.flexDirection = 'column';
                        card.style.alignItems = 'center';
                        card.style.gap = '7px';
                        card.innerHTML = `<img src="${anime.poster}" alt="${anime.title}" style="width:80px;height:110px;border-radius:8px;object-fit:cover;">` +
                            `<div style='color:#ffb84b;font-weight:600;text-align:center;'>${anime.title}</div>` +
                            `<button class='remove-anime-btn' style='background:#ff4b4b;color:#fff;border:none;border-radius:7px;padding:4px 12px;font-size:0.97rem;font-weight:600;cursor:pointer;margin-top:4px;'>O‘chirish</button>`;
                        card.querySelector('.remove-anime-btn').onclick = function() {
                            pl.animeIds = pl.animeIds.filter(i => i !== id);
                            savePlaylists(playlists);
                            openPlaylistAnimeModal(idx);
                        };
                        card.onclick = function(e) {
                            if (e.target.classList.contains('remove-anime-btn')) return;
                            window.location.href = 'anime.html?id=' + anime.id;
                        };
                        animeListDiv.appendChild(card);
                    }
                });
                animeListDiv.style.display = 'flex';
                animeEmpty.style.display = 'none';
            } else {
                animeListDiv.style.display = 'none';
                animeEmpty.style.display = '';
            }
            addAnimeList.style.display = 'none';
            animeModal.style.display = 'flex';
        }
        if (closeAnimeModal && animeModal) closeAnimeModal.onclick = () => { animeModal.style.display = 'none'; };
        // Anime qo‘shish
        if (addAnimeBtn && addAnimeList) {
            addAnimeBtn.onclick = function() {
                addAnimeList.innerHTML = '';
                const playlists = getPlaylists();
                const pl = playlists[currentPlaylistIdx];
                if (typeof animeData !== 'undefined') {
                    animeData.forEach(anime => {
                        if (!pl.animeIds.includes(anime.id)) {
                            const card = document.createElement('div');
                            card.style.background = '#23243a';
                            card.style.borderRadius = '8px';
                            card.style.width = '120px';
                            card.style.boxShadow = '0 1px 6px #0001';
                            card.style.padding = '7px 6px 10px 6px';
                            card.style.display = 'flex';
                            card.style.flexDirection = 'column';
                            card.style.alignItems = 'center';
                            card.style.gap = '5px';
                            card.innerHTML = `<img src="${anime.poster}" alt="${anime.title}" style="width:60px;height:80px;border-radius:6px;object-fit:cover;">` +
                                `<div style='color:#ffb84b;font-weight:600;text-align:center;font-size:0.97rem;'>${anime.title}</div>` +
                                `<button class='add-anime-btn' style='background:#3bb6ff;color:#fff;border:none;border-radius:7px;padding:3px 10px;font-size:0.95rem;font-weight:600;cursor:pointer;margin-top:2px;'>Qo‘shish</button>`;
                            card.querySelector('.add-anime-btn').onclick = function() {
                                pl.animeIds.push(anime.id);
                                savePlaylists(playlists);
                                openPlaylistAnimeModal(currentPlaylistIdx);
                            };
                            addAnimeList.appendChild(card);
                        }
                    });
                }
                addAnimeList.style.display = 'flex';
            };
        }
        renderPlaylists();
    });
    // Banner va avatar tahrirlash modal funksionalligi
    document.addEventListener('DOMContentLoaded', function() {
        const editBtn = document.getElementById('editProfileBtn');
        const modal = document.getElementById('editProfileModal');
        const closeModal = document.getElementById('closeEditProfileModal');
        const bannerInput = document.getElementById('editBannerInput');
        const avatarInput = document.getElementById('editAvatarInput');
        const bannerPreview = document.getElementById('editBannerPreview');
        const avatarPreview = document.getElementById('editAvatarPreview');
        const form = document.getElementById('editProfileForm');
        const nameInput = document.getElementById('editNameInput');
        // Modal ochish
        if (editBtn && modal) {
            editBtn.onclick = function() {
                // Banner preview
                let banner = localStorage.getItem('profileBanner');
                if (banner) {
                    bannerPreview.src = banner;
                    bannerPreview.style.display = '';
                } else {
                    bannerPreview.style.display = 'none';
                }
                // Avatar preview
                let avatar = localStorage.getItem('avatar');
                if (avatar) {
                    avatarPreview.src = avatar;
                    avatarPreview.style.display = '';
                } else {
                    avatarPreview.style.display = 'none';
                }
                // Nik input
                if (nameInput) {
                    nameInput.value = localStorage.getItem('username') || '';
                }
                modal.style.display = 'flex';
            };
        }
        // Modal yopish
        if (closeModal && modal) {
            closeModal.onclick = function() {
                modal.style.display = 'none';
            };
        }
        // Banner preview yuklash
        if (bannerInput && bannerPreview) {
            bannerInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        bannerPreview.src = evt.target.result;
                        bannerPreview.style.display = '';
                    };
                    reader.readAsDataURL(file);
                }
            };
        }
        // Avatar preview yuklash
        if (avatarInput && avatarPreview) {
            avatarInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        avatarPreview.src = evt.target.result;
                        avatarPreview.style.display = '';
                    };
                    reader.readAsDataURL(file);
                }
            };
        }
        // Saqlash
        if (form) {
            form.onsubmit = function(e) {
                e.preventDefault();
                // Banner
                if (bannerPreview && bannerPreview.src && bannerPreview.style.display !== 'none') {
                    localStorage.setItem('profileBanner', bannerPreview.src);
                }
                // Avatar
                if (avatarPreview && avatarPreview.src && avatarPreview.style.display !== 'none') {
                    localStorage.setItem('avatar', avatarPreview.src);
                }
                // Nik (ism)
                if (nameInput && nameInput.value.trim()) {
                    localStorage.setItem('username', nameInput.value.trim());
                }
                modal.style.display = 'none';
                window.location.reload();
            };
        }
    });
    // Profil sahifasini localStorage va animeData bilan to'ldirish
    document.addEventListener('DOMContentLoaded', function() {
        // Avatar, ism, email
        // Banner ko'rsatish
        let banner = localStorage.getItem('profileBanner');
        if (banner) {
            document.querySelector('.profile-hero').style.backgroundImage = `url('${banner}'), linear-gradient(120deg, #23243a 60%, #181a20 100%)`;
        }
        document.getElementById('profilePageAvatar').src = localStorage.getItem('avatar') || 'images/default-avatar.png';
        document.getElementById('profilePageName').textContent = localStorage.getItem('username') || 'Foydalanuvchi';
        document.getElementById('profilePageEmail').textContent = localStorage.getItem('email') || 'email@example.com';
        // Sevimli animelar
        const favList = document.getElementById('profilePageFavorites');
        const favEmpty = document.getElementById('profilePageFavoritesEmpty');
        favList.innerHTML = '';
        let favIds = JSON.parse(localStorage.getItem('savedAnimeIds') || '[]');
        if (typeof animeData !== 'undefined' && favIds.length > 0) {
            favIds.forEach(id => {
                const anime = animeData.find(a => a.id === id);
                if (anime) {
                    const li = document.createElement('li');
                    li.innerHTML = `<img src="${anime.poster}" alt="${anime.title}"><span>${anime.title}</span>`;
                    favList.appendChild(li);
                }
            });
            favList.style.display = '';
            favEmpty.style.display = 'none';
        } else {
            favList.style.display = 'none';
            favEmpty.style.display = '';
        }
        // Ko‘rilgan animelar statistikasi
        const statsDiv = document.getElementById('profilePageStats');
        let viewedIds = JSON.parse(localStorage.getItem('recentlyViewedAnime') || '[]');
        let viewedCount = viewedIds.length;
        let totalEpisodes = 0;
        let totalMinutes = 0;
        if (typeof animeData !== 'undefined' && viewedIds.length > 0) {
            viewedIds.forEach(id => {
                const anime = animeData.find(a => a.id === id);
                if (anime) {
                    totalEpisodes += anime.episodes || 0;
                    totalMinutes += (anime.episodes || 0) * 23;
                }
            });
        }
        let hours = Math.floor(totalMinutes / 60);
        let minutes = totalMinutes % 60;
        statsDiv.innerHTML = `<span style='color:#ffb84b;'>Ko‘rilgan anime soni:</span> ${viewedCount}<br>` +
            `<span style='color:#ffb84b;'>Umumiy epizodlar:</span> ${totalEpisodes}<br>` +
            `<span style='color:#ffb84b;'>Umumiy vaqt:</span> ${hours} soat ${minutes} daqiqa`;
        // Daraja
        const badgeDiv = document.getElementById('profilePageBadge');
        let badge = '';
        if (viewedCount === 0) {
            badge = "Yangi foydalanuvchi";
            badgeDiv.style.background = '#b2b6c8'; badgeDiv.style.color = '#23243a';
        } else if (viewedCount < 3) {
            badge = "Anime boshlovchisi";
            badgeDiv.style.background = '#3bb6ff'; badgeDiv.style.color = '#fff';
        } else if (viewedCount < 7) {
            badge = "Anime ixlosmandi";
            badgeDiv.style.background = '#ffb84b'; badgeDiv.style.color = '#23243a';
        } else {
            badge = "Anime ustasi";
            badgeDiv.style.background = '#ff4b4b'; badgeDiv.style.color = '#fff';
        }
        badgeDiv.textContent = badge;

        // So‘nggi ko‘rilgan animelar (short preview)
        const recShort = document.getElementById('profilePageRecentlyShort');
        const recEmpty = document.getElementById('profilePageRecentlyEmpty');
        recShort.innerHTML = '';
        if (typeof animeData !== 'undefined' && viewedIds.length > 0) {
            viewedIds.slice(0, 3).forEach(id => {
                const anime = animeData.find(a => a.id === id);
                if (anime) {
                    const img = document.createElement('img');
                    img.src = anime.poster;
                    img.alt = anime.title;
                    img.style.width = '32px';
                    img.style.height = '44px';
                    img.style.borderRadius = '6px';
                    img.style.objectFit = 'cover';
                    recShort.appendChild(img);
                }
            });
            recShort.style.display = 'flex';
            recEmpty.style.display = 'none';
        } else {
            recShort.style.display = 'none';
            recEmpty.style.display = '';
        }

        // Modal funksionallik
        const openModalBtn = document.getElementById('openRecentlyModal');
        const closeModalBtn = document.getElementById('closeRecentlyModal');
        const recentlyModal = document.getElementById('recentlyModal');
        const recentlyModalList = document.getElementById('recentlyModalList');
        if (openModalBtn && recentlyModal && recentlyModalList) {
            openModalBtn.onclick = function() {
                // Kartochkalar ko‘rinishida chiqarish
                recentlyModalList.innerHTML = '';
                if (typeof animeData !== 'undefined' && viewedIds.length > 0) {
                    viewedIds.forEach(id => {
                        const anime = animeData.find(a => a.id === id);
                        if (anime) {
                            const card = document.createElement('div');
                            card.style.background = '#181a20';
                            card.style.borderRadius = '10px';
                            card.style.width = '140px';
                            card.style.boxShadow = '0 2px 12px #0002';
                            card.style.padding = '10px 8px 12px 8px';
                            card.style.display = 'flex';
                            card.style.flexDirection = 'column';
                            card.style.alignItems = 'center';
                            card.style.gap = '7px';
                            card.innerHTML = `<img src="${anime.poster}" alt="${anime.title}" style="width:80px;height:110px;border-radius:8px;object-fit:cover;">` +
                                `<div style='color:#ffb84b;font-weight:600;text-align:center;'>${anime.title}</div>` +
                                `<div style='color:#b2b6c8;font-size:0.97rem;text-align:center;'>${anime.year || ''}</div>`;
                            card.onclick = function() {
                                window.location.href = 'anime.html?id=' + anime.id;
                            };
                            card.style.cursor = 'pointer';
                            recentlyModalList.appendChild(card);
                        }
                    });
                } else {
                    recentlyModalList.innerHTML = '<div style="color:#b2b6c8;font-size:1.05rem;">So‘nggi ko‘rilgan animelar yo‘q</div>';
                }
                recentlyModal.style.display = 'flex';
            };
        }
        if (closeModalBtn && recentlyModal) {
            closeModalBtn.onclick = function() {
                recentlyModal.style.display = 'none';
            };
        }

        // Sozlamalar
        const langSelect = document.getElementById('profilePageLang');
        const themeSelect = document.getElementById('profilePageTheme');
        langSelect.value = localStorage.getItem('site-lang') || 'uz';
        themeSelect.value = localStorage.getItem('theme') || 'dark';
        langSelect.onchange = function() {
            localStorage.setItem('site-lang', langSelect.value);
            window.location.reload();
        };
        themeSelect.onchange = function() {
            localStorage.setItem('theme', themeSelect.value);
            window.location.reload();
        };
    });
    </script>
</body>
</html>
